<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
<head>
  <title>included (ThinkingSphinx::ActiveRecord)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre><span class="ruby-comment cmt"># File lib/thinking_sphinx/active_record.rb, line 12</span>
    <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">included</span>(<span class="ruby-identifier">base</span>)
      <span class="ruby-identifier">base</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-keyword kw">do</span>
        <span class="ruby-identifier">class_inheritable_array</span> <span class="ruby-identifier">:sphinx_indexes</span>, <span class="ruby-identifier">:sphinx_facets</span>
        
        <span class="ruby-identifier">extend</span> <span class="ruby-constant">ThinkingSphinx</span><span class="ruby-operator">::</span><span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">ClassMethods</span>
        
        <span class="ruby-keyword kw">class</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword kw">self</span>
          <span class="ruby-identifier">attr_accessor</span> <span class="ruby-identifier">:sphinx_index_blocks</span>
          
          <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_sphinx_primary_key</span>(<span class="ruby-identifier">attribute</span>)
            <span class="ruby-ivar">@sphinx_primary_key_attribute</span> = <span class="ruby-identifier">attribute</span>
          <span class="ruby-keyword kw">end</span>
          
          <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">primary_key_for_sphinx</span>
            <span class="ruby-ivar">@sphinx_primary_key_attribute</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">primary_key</span>
          <span class="ruby-keyword kw">end</span>
          
          <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sphinx_index_options</span>
            <span class="ruby-identifier">sphinx_indexes</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">options</span>
          <span class="ruby-keyword kw">end</span>
          
          <span class="ruby-comment cmt"># Generate a unique CRC value for the model's name, to use to</span>
          <span class="ruby-comment cmt"># determine which Sphinx documents belong to which AR records.</span>
          <span class="ruby-comment cmt"># </span>
          <span class="ruby-comment cmt"># Really only written for internal use - but hey, if it's useful to</span>
          <span class="ruby-comment cmt"># you in some other way, awesome.</span>
          <span class="ruby-comment cmt"># </span>
          <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">to_crc32</span>
            <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_crc32</span>
          <span class="ruby-keyword kw">end</span>
          
          <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">to_crc32s</span>
            (<span class="ruby-identifier">subclasses</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword kw">self</span>).<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">klass</span><span class="ruby-operator">|</span> <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">to_crc32</span> }
          <span class="ruby-keyword kw">end</span>
          
          <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sphinx_database_adapter</span>
            <span class="ruby-ivar">@sphinx_database_adapter</span> <span class="ruby-operator">||=</span>
              <span class="ruby-constant">ThinkingSphinx</span><span class="ruby-operator">::</span><span class="ruby-constant">AbstractAdapter</span>.<span class="ruby-identifier">detect</span>(<span class="ruby-keyword kw">self</span>)
          <span class="ruby-keyword kw">end</span>
          
          <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sphinx_name</span>
            <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">underscore</span>.<span class="ruby-identifier">tr</span>(<span class="ruby-value str">':/\\'</span>, <span class="ruby-value str">'_'</span>)
          <span class="ruby-keyword kw">end</span>
          
          <span class="ruby-comment cmt">#</span>
          <span class="ruby-comment cmt"># The above method to_crc32s is dependant on the subclasses being loaded consistently</span>
          <span class="ruby-comment cmt"># After a reset_subclasses is called (during a Dispatcher.cleanup_application in development)</span>
          <span class="ruby-comment cmt"># Our subclasses will be lost but our context will not reload them for us.</span>
          <span class="ruby-comment cmt">#</span>
          <span class="ruby-comment cmt"># We reset the context which causes the subclasses to be reloaded next time the context is called.</span>
          <span class="ruby-comment cmt">#</span>
          <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">reset_subclasses_with_thinking_sphinx</span>
            <span class="ruby-identifier">reset_subclasses_without_thinking_sphinx</span>
            <span class="ruby-constant">ThinkingSphinx</span>.<span class="ruby-identifier">reset_context!</span>
          <span class="ruby-keyword kw">end</span>
          
          <span class="ruby-identifier">alias_method_chain</span> <span class="ruby-identifier">:reset_subclasses</span>, <span class="ruby-identifier">:thinking_sphinx</span>
          
          <span class="ruby-identifier">private</span>
          
          <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">defined_indexes?</span>
            <span class="ruby-ivar">@defined_indexes</span>
          <span class="ruby-keyword kw">end</span>
          
          <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">defined_indexes=</span>(<span class="ruby-identifier">value</span>)
            <span class="ruby-ivar">@defined_indexes</span> = <span class="ruby-identifier">value</span>
          <span class="ruby-keyword kw">end</span>
          
          <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sphinx_delta?</span>
            <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">sphinx_indexes</span>.<span class="ruby-identifier">any?</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span> <span class="ruby-identifier">index</span>.<span class="ruby-identifier">delta?</span> }
          <span class="ruby-keyword kw">end</span>
        <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">end</span>
      
      <span class="ruby-operator">::</span><span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Associations</span><span class="ruby-operator">::</span><span class="ruby-constant">HasManyAssociation</span>.<span class="ruby-identifier">send</span>(
        <span class="ruby-identifier">:include</span>, <span class="ruby-constant">ThinkingSphinx</span><span class="ruby-operator">::</span><span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">HasManyAssociation</span>
      )
      <span class="ruby-operator">::</span><span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Associations</span><span class="ruby-operator">::</span><span class="ruby-constant">HasManyThroughAssociation</span>.<span class="ruby-identifier">send</span>(
        <span class="ruby-identifier">:include</span>, <span class="ruby-constant">ThinkingSphinx</span><span class="ruby-operator">::</span><span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">HasManyAssociation</span>
      )
    <span class="ruby-keyword kw">end</span></pre>
</body>
</html>